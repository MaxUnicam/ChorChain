<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Deploy of smart contract</title>
<script
	src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js"
	integrity="sha256-nWBTbvxhJgjslRyuAKJHK+XcZPlCnmIAAMixz6EefVk="
	crossorigin="anonymous"></script>
	<script src="lib/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.6/angular-cookies.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<link href="website.css" rel="stylesheet" type="text/css"> 
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" 
	integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" 
	crossorigin="anonymous">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.33.1/sweetalert2.all.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.33.1/sweetalert2.min.css">
	
	<!-- Modeler import -->
		<link rel="stylesheet" href="css/diagram-js.css" />
		<link rel="stylesheet" href="vendor/bpmn-js/assets/bpmn-font/css/bpmn.css" />
		<link rel="stylesheet" href="vendor/chor-js/font/include/css/choreography.css" />
		<link rel="stylesheet" href="css/app.css" />
		<link rel="stylesheet" href="css/chor-editor.css"/>
	<!-- Modeler end import -->
<style>
.btn-secondary:not(:disabled):not(.disabled).active{
    background-color: #6c757d;
    border-color: #6c757d;
    color: #fff;
}

.vertical-divider {
    position: absolute;
    z-index: 10;
    top: 50%;
    left: 50%;
    margin: 0;
    padding: 0;
    width: auto;
    height: 50%;
    line-height: 0;
    text-align: center;
    text-transform: uppercase;
    transform: translateX(-50%);
}
</style>
</head>
<body ng-app="monitor" ng-controller="monitorCtrl">
				<div class="content with-diagram" id="js-drop-zone" style="weight:100%;height:78%;">

				<div id="canvas" data-ng-init="attach()"></div>		
				<a href="homePage.html"><button type="button" class="btn btn-default" style="width:75px;height:45px;">Back</button></a>   
				</div>

	<div class="row">
    	<div class="col">
    	
		   <button class="col btn btn-secondary" id="js-new-diagram" style="height:40px;width:150px;margin-left:23px;" onclick="newModel()" title="Create a new Choreograpy Model">Create Model <a class="fas fa-plus-circle"></a></button>
					
		   <button class="col btn btn-secondary" style="height:40px;width:150px;margin-left:23px;" title="Import a Choreograpy Model" onclick="document.getElementById('input').click()"> Import Model <a class="fas fa-upload"></a> </button> 
		   <input type="file" id="input" style="display:none;" accept=".bpmn, .xml" onchange="importModel()"/>	
   		</div>
    </div>
    <div class="row">
        <div class="col">
    <button class="col btn btn-secondary" id="save" style="height:40px;width:150px;margin-left:23px;" title="Save Model" onclick="saveModel()">Save Model <i class="fa fa-inbox"></i></button>
     <button class="col btn btn-secondary" id="js-preview" style="height:40px;width:150px;margin-left:23px;" title="Save Model">Preview <i class="fa fa-inbox"></i></button>			
  	<button class="col btn btn-secondary" style="height:40px;width:150px;margin-left:23px;" title="Download Model" data-toggle="modal" data-target="#modalDownload">Export Model <a class="fas fa-download"></a></button>				
        </div>   
    </div>

<!-- Modal download -->
<div id="modalDownload" class="modal fade" role="dialog">
  <div class="modal-dialog centered">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Model {{model.name}} Download </h4>
      </div>

        <div class="modal-body">
			<div class="row">
        		<div class="col ">     		
      
   				    <a id="js-download-diagram" class="col btn btn-secondary" style="height:40px;width:200px;margin-left:23px;font-weight:400;text-align:center;" title="Download BPMN file">Download BPMN file <i class="far fa-file"></i></a>

   				    <a id="js-download-svg" class="col btn btn-secondary"  style="height:40px;width:200px;margin-left:23px;font-weight:400;text-align:center;" title="Download as SVG image">Download as SVG image <i class="far fa-file-image"></i></a>
 		
		 		</div>   
		    </div>		
	   </div>
       
       <div class="modal-footer">

        <button type="button" class="btn btn-default" data-dismiss="modal" >Close</button>   
      </div>
	</div>
   </div>
  </div>

<!-- end modal download -->


				
	<script src="lib/appmodeler.js"></script>
	
	<script src="lib/controller.js"></script>
	<script src="lib/service.js"></script>
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.6/angular-cookies.js"></script>
</body>

<script>
function saveModel() {
	Swal.fire({
		  type: 'success',
		  title: 'Your model has been saved',
		  showConfirmButton: false,
		  timer: 1700,
		  backdrop: false
		})
}
</script>

<script>
function newModel() {
	swal({
		  title: 'Insert the new model name',
		  input: 'text',
		  backdrop: false,
		  confirmButtonText: 'Submit',
		  showLoaderOnConfirm: true,
		  preConfirm: function (text) {
		    return new Promise(function (resolve, reject) {
		      setTimeout(function() {
		        if (text === 'taken') {
		          reject('This name is already taken.')
		        } else {
		          resolve()
		        }
		      }, 2000)
		    })
		  },
		  allowOutsideClick: false
		}).then(function (text) {
		  swal({
		    type: 'success',
		    title: 'Model created!',
		    backdrop: false,
		  })
		})
}
</script>

<script>
function importModel() {
	let timerInterval
	Swal.fire({
	  title: 'Importing a model...',
	  backdrop: false,
	  timer: 600,
	  onBeforeOpen: () => {
	    Swal.showLoading()
	    timerInterval = setInterval(() => {
	      Swal.getContent().querySelector('strong')
	        .textContent = Swal.getTimerLeft()
	    }, 100)
	  },
	  onClose: () => {
	    clearInterval(timerInterval)
	  }
	}).then((result) => {
	  if (
	    // Read more about handling dismissals
	    result.dismiss === Swal.DismissReason.timer
	  ) {
	    console.log('I was closed by the timer')
	  }
	})
}
</script>

<script>

var app = angular.module('monitor', ['ngCookies']);

app.controller("monitorCtrl",function($scope, $http, $cookies, $window) {
	
	$scope.user = {};
	$scope.sendParams = {};
	$scope.contracts = {};
	$scope.tasks = {};
	//var web3 = new Web3("http://193.205.92.133:8545");
    var web777 = new Web3("ws://193.205.92.133:8546");
    $scope.actualContract = {};
    $scope.myContract = {};
    $scope.abi = {};
    $scope.inputs = {};
    $scope.memory = {};
 	$scope.msgs = {};
 	$scope.singleMemory = null;
 	$scope.index = null;
 	$scope.valueNames = {};
 	$scope.currentRole = "";
    
	//var abiContract = JSON.parse(sessionStorage.getItem('contract'));
	
	//$scope.params = $scope.contract.tasks[0].params[0].split(",");
	

	//var myContract = new web3.eth.Contract(JSON.parse($scope.contract.abi), $scope.contract.address);


	
	
$scope.launch =  async function(task, $index, refresh){
	
	
		var params = $scope.sendParams.par;
		var name = $scope.actualContract.tasks[$index];
		console.log($scope.actualContract.tasks[$index]);
		var n1 = name.split('\(');
		//var n2 = n1.split(',');
		var n3 = n1[1].split(' ');
		console.log(n3);
		var complete = task + '(';
		for(var i in n3){

			if(n3[i] == 'uint' || n3[i] == 'string' || n3[i] == 'bool'){
				if(n3[i] == 'uint'){
					n3[i] = 'uint256';
				}
				complete += n3[i] + ' , ';
			}
		}
		var addPar = complete.split(' ');
	 	console.log(addPar);
		addPar.pop();
		addPar.pop();
		console.log(addPar);
		complete = "";
		for(i in addPar){
			complete += addPar[i];
		}
		complete += ')';
		var replaced = complete.replace(/-/g,'_');
		for(var method in $scope.myContract.methods){
			if(method == replaced){
			//await unlock();
			var parArray = [];
			if($scope.sendParams.par.includes(',')){
				var a = $scope.sendParams.par;
				parArray = a.split('\,');
			}
			else{
				parArray.push($scope.sendParams.par);
			}
			console.log(parArray);
				$scope.myContract.methods[method].apply(this, parArray).send({
					from : $scope.user.address,
					gas: 200000,
				}).then(function(error, receipt){
				//	console.log(error);
							//console.log(receipt);
						//	$scope.getTask(refresh);
				});
			}
		}
	}
	
	
	
	$scope.getUserContracts = function(){
		
		$http.post("rest/getCont/" + $cookies.get('UserId')).then(function(response){
			$scope.contracts = response.data;
			console.log($scope.contracts);
		});
	}
	
	$scope.getSingleMem = function(){
		for(var i in $scope.memory){
		//console.log(i);
		}
		
		$scope.singleMemory = $scope.memory[$scope.index];
		//console.log($scope.singleMemory);
	}
	
	$scope.getTask = function(name){
		$scope.msgs = null;
		$scope.memory = null;
		$scope.sendParams.par = null;
		console.log($scope.msgs);
		for(var i in $scope.contracts){
			if($scope.contracts[i].name == name){
				$scope.actualContract =  $scope.contracts[i];
				$scope.tasks = $scope.contracts[i].tasks;
				$scope.valueNames = $scope.contracts[i].varNames;
				break;
			}
		}
		$scope.abi = JSON.parse($scope.actualContract.abi);
		$scope.myContract = new web3.eth.Contract($scope.abi, $scope.actualContract.address);
		
		console.log($scope.myContract);
		$scope.myContract.methods.getCurrentState().call().then(function(receipt){
			$scope.$apply(function(recepit){
				$scope.msgs = receipt[0];
				$scope.memory = receipt[1];
				$scope.setRoleActive();
				sub(name);
			});

			
		});
		
		
		
		
	}
	
	$scope.setUser = function(){
		$http.post("rest/getUserInfo/" + $cookies.get('UserId')).then(function(response){
		
			$scope.user = response.data;
			//console.log($scope.user);
		});
	}
	
	async function unlock(){
		console.log($scope.user);
		//TODO java method. optional: rimettere psw quando tento di sbloccare account $scope.user.address
		/*$http.post("rest/getUserInfo/").then(function(response){
			 web3.eth.personal.unlockAccount(
					response.data.address, response.data.privateKey)
					.then(console.log('Account unlocked'));
		});*/console.log($scope.user.address);
		await web3.eth.personal.unlockAccount($scope.user.address
					, $scope.user.privateKey, 10000)
					.then(console.log('Account unlocked'));
	}
	
		function sub1(refresh){
			console.log("i'm the sub starting");
		for(var type in $scope.abi){
			if($scope.abi[type].name=="stateChanged"){
				$scope.inputs = $scope.abi[type].inputs;
			}
		}
		const subscription = web777.eth.subscribe('logs', {
		    //address: $scope.actualContract.address,
		    address : $scope.actualContract.address,
		    topics: ['0x8fd8f487a1d703cca2ded1250c8e7c8c1ae6f0b6cdc81883a282e0863a6d7283']//prendere da bytecode
		}, function(error, result){
			console.log("inside sub on callback");
			 if (!error) {
				 	console.log("inside sub on good");
			        const eventObj = web3.eth.abi.decodeLog(
			            $scope.inputs,
			            result.data,
			            result.topics
			          )
			        $scope.actualContract =  null;
					$scope.tasks = null;
					$scope.valueNames = null;
			     //   $scope.getTask(refresh);
			      //  $scope.getTask(refresh);
			       
			      }
			 else
				 console.log(error);    
			});
		}
		
	
	
	$scope.getPast = function(){
		myContract.getPastEvents('allEvents', {
		    fromBlock: 0,
		    toBlock: 'latest'
		}, (error, events) => { console.log(events); })
		.then((events) => {
		    console.log(events) 
		});
	}
	
	$scope.setRoleActive = function(){
		var activeSid = {};
		//console.log($scope.actualContract);
		for(var i in $scope.msgs){

			if($scope.msgs[i].status == 1){
				$scope.msgs[i].show = 1;
				activeSid = $scope.msgs[i].ID;
				$scope.msgs[i].status = "Enabled";
				$scope.currentRole = $scope.actualContract.taskRoles[i];
				
			}
			else if($scope.msgs[i].status == 0){
				$scope.msgs[i].status = "Disabled";
			}
			else if($scope.msgs[i].status == 2){
				$scope.msgs[i].status = "Done";
			}
		}

		for(var i in $scope.actualContract.tasksID){
			
			if($scope.actualContract.tasksID[i] == activeSid){
				/*console.log("ecco il sid del contratto:" + $scope.actualContract.tasksID[i]);
				console.log("con nome: " + $scope.actualContract.tasks[i]);
				console.log("e role: " +  $scope.actualContract.taskRoles[i])
				/*for(var r in $scope.user.userRoles[r]){
					if(){
						hyzh
					}
				}*/
			}
		}
	
	}
	
	$scope.addMeta = function(){
		$window.addEventListener("load", function() {
		    if (typeof web3 !== "undefined") {
		     web3 = new Web3(web3.currentProvider);
		     console.log(web3);
		      //web3.eth.getAccounts().then(console.log);
		    } else {
		      console.log("No web3? You should consider trying MetaMask!");
		    }

		  });
	}
	
	function sub(refresh){
		for(var type in $scope.abi){
			if($scope.abi[type].name=="stateChanged"){
				$scope.inputs = $scope.abi[type].inputs;
			}
		}
		console.log("dentro il sub");
		$scope.myContract.events.stateChanged((error, result) => {
			const eventObj = web3.eth.abi.decodeLog(
		            $scope.inputs,
		            result.data,
		            result.topics
		          )
		        $scope.actualContract =  null;
				$scope.tasks = null;
				$scope.valueNames = null;
		        $scope.getTask(refresh);	
		});
		
			}
	
	
	$scope.addMeta();
	$scope.getUserContracts();
	$scope.setUser();
	
	//deve partire quando clicco contratto sub();
	
	
});


	
</script>
</html>